---
title: "Survival Analysis Simulation Study"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
```

Create a function that will create a dataset from a specific baseline hazard function

```{r}

# N = sample size    
# lambda = scale parameter in exponential, weibull, "cox" (> 0)
# gamma = shape parameter in weibull (> 0)
# alpha = shape parameter in "cox" (-inf to inf)
# beta = fixed treatment effect parameter
set.seed(123123)

generate_data = function(N, beta, distribution, lambda, gamma, alpha) {
  
  #Inverse survival function from baseline hazard functions to obtain event times
  exponential = function(u, x, lambda, beta) {
    time = -log(u) / (exp(x * beta) * lambda) }
  
  weibull = function(u, x, lambda, gamma, beta) {
    time = ( -log(u) / (exp(x * beta) * lambda) ) ^ (1 / gamma) }
  
  cox = function(u, x, lambda, alpha, beta) {
    time = (1/alpha) * log( 1 - (alpha * log(u) / (lambda * exp(beta * x))) ) }
  
  #treatment assignment
  x = 1 * (runif(N) < 0.5)

  #generate event times
  u = runif(N)
  
  if (distribution == "exponential") {
    time = exponential(u, x, lambda, beta) } 
  else if (distribution == "weibull") {
    time = weibull(u, x, lambda, gamma, beta) }
  else { 
    time = cox(u, x, lambda, alpha, beta) } 
  
  #censoring time
  C = rexp(N, lambda)

  # follow-up times and event indicators
  observed_time = pmin(time, C)
  status = 1 * (time >= C)

  # data set
  survival_data = data.frame(id = 1:N,
                             time = time,
                             observed_time = observed_time,
                             status = status,
                             x = x)
}
```

Scenario 1: exponential baseline hazard

```{r}

#try different betas [0, 10]
#try different N (100, 250, 500, 1000)
#possibly vary lambda, gamma, alpha - not a priority

data = generate_data(N = 500, beta = 5, distribution = "exponential", lambda = 0.1, gamma = 4, alpha = 4)

fit.exponential = survreg(Surv(data$observed_time, data$status) ~ data$x, dist = "exponential") 
#summary(fit.exponential)
- fit.exponential$coefficients[-1]

fit.weibull = survreg(Surv(data$time, data$status) ~ data$x, dist = "weibull") 
#summary(fit.weibull)
- fit.weibull$coefficients[-1] / fit.weibull$scale



```

Scenario 2: weibull baseline hazard

```{r}

#try different betas [0, 10]
#try different N (100, 250, 500, 1000)
#possibly vary lambda, gamma, alpha - not a priority


  for (i in 1:N){
  data = generate_data(N = 500, beta = 6, distribution = "weibull", lambda = 0.1,
                       gamma = 4, alpha = 42)
  
  # Fit three survival distributions
  fit.exponential = survreg(Surv(data$time) ~ data$x, dist = "exponential") 
  fit.weibull = survreg(Surv(data$time) ~ data$x, dist = "weibull")
  fit.cox = coxph(Surv(data$time) ~ data$x) 
  
  # Save beta coefficients 
  exp_beta[i] = -fit.exponential$coefficients[-1]
  weibull_beta[i] = -fit.weibull$coefficients[-1] / fit.weibull$scale
  cox_beta[i] = fit.cox$coefficients[1]
  }
  



fit.exponential = survreg(Surv(data$time) ~ data$x, dist = "exponential") 
#summary(fit.exponential)
- fit.exponential$coefficients[-1]

fit.weibull = survreg(Surv(data$time) ~ data$x, dist = "weibull") 
#summary(fit.weibull)
- fit.weibull$coefficients[-1] / fit.weibull$scale

fit.cox = coxph(Surv(data$time) ~ data$x) 
summary(fit.cox)
```

Scenario 3: Gompertz baseline hazard

```{r}

#try different betas [0, 10]
#try different N (100, 250, 500, 1000)
#possibly vary lambda, gamma, alpha (not a priority)

data = generate_data(N = 500, beta = 6, distribution = "cox", lambda = 0.1, gamma = 4, alpha = 4)

fit.exponential = survreg(Surv(data$time) ~ data$x, dist = "exponential") 
#summary(fit.exponential)
- fit.exponential$coefficients[-1]

fit.weibull = survreg(Surv(data$time) ~ data$x, dist = "weibull") 
#summary(fit.weibull)
- fit.weibull$coefficients[-1] / fit.weibull$scale

fit.cox = coxph(Surv(data$time) ~ data$x) 
summary(fit.cox)

```

