---
title: "Scenario 3: Non-parametric Cox Model"
author: "Adina Zhang"
date: "February 7, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(survival)
source("./sim.R")
```

```{r, message = FALSE, warning = FALSE}
# Write a function for simulations
simulate = function(sim, N, beta) {
  # Set up coefficient vectors
  exp_beta = rep(NA, sim)
  weibull_beta = rep(NA, sim)
  cox_beta = rep(NA, sim)
  
  for (i in 1:sim) {
    # Generate data
    data = generate_data(N, beta, distribution = "cox", 
                         lambda = 0.1, gamma = 4, alpha = 4)
    # Fit three survival distributions
    fit.exponential = survreg(Surv(data$time) ~ data$x, dist = "exponential") 
    fit.weibull = survreg(Surv(data$time) ~ data$x, dist = "weibull")
    fit.cox = coxph(Surv(data$time) ~ data$x)
  
     # Save beta coefficients 
    exp_beta[i] = -fit.exponential$coefficients[-1]
    weibull_beta[i] = -fit.weibull$coefficients[-1] / fit.weibull$scale
    cox_beta[i] = fit.cox$coefficients[1]
  }
  
  # Calculate bias and MSE for each model
  exp_bias = (sum(beta - exp_beta)) / sim 
  weibull_bias = (sum(beta - weibull_beta)) / sim
  cox_bias = (sum(beta - cox_beta)) / sim
  exp_MSE = (sum(beta - exp_beta)^2) / sim
  weibull_MSE = (sum(beta - weibull_beta)^2) / sim
  cox_MSE = (sum(beta - cox_beta)^2) / sim
  
  # Store performance measures in a dataset
  perf_data = tibble(model = c("exp", "weibull", "cox"),
                     bias = c(exp_bias, weibull_bias, cox_bias),
                     mse = c(exp_MSE, weibull_MSE, cox_MSE))
  
  return(perf_data)
}


```


```{r}
set.seed(12345)
sim_results = 
  tibble(sample_size = c(100, 150, 200, 250, 300, 350, 400, 450, 500)) %>% 
  mutate(
    output_lists = map(.x = sample_size, ~simulate(sim = 10, N = .x, beta = 4)),
    estimate_dfs = map(output_lists, bind_rows)) %>% 
  select(-output_lists) %>% 
  unnest(estimate_dfs)

sim_results %>% 
  ggplot(aes(x = sample_size, y = mse, color = model)) + 
  geom_point() +
  geom_line() + 
  theme_bw()

set.seed(12345)
sim_results = 
  tibble(beta = c(0.1, 0.5, 1, 3, 5, 6)) %>% 
  mutate(
    output_lists = map(.x = beta, ~simulate(sim = 100, N = 500, beta = .x)),
    estimate_dfs = map(output_lists, bind_rows)) %>% 
  select(-output_lists) %>% 
  unnest(estimate_dfs)

sim_results %>% 
  ggplot(aes(x = beta, y = mse, color = model)) + 
  geom_point() +
  geom_line() + 
  theme_bw()

```

